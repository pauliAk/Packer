{
  "packer": {
    "required_plugins": {
      "azure": {
        "version": ">= 1.0.0",
        "source": "github.com/hashicorp/azure"
      }
    }
  },
  "variables": {
    "client_id": {
      "type": "string",
      "default": "${env(\"ARM_CLIENT_ID\")}"
    },
    "client_secret": {
      "type": "string",
      "default": "${env(\"ARM_CLIENT_SECRET\")}"
    },
    "subscription_id": {
      "type": "string",
      "default": "${env(\"ARM_SUBSCRIPTION_ID\")}"
    },
    "tenant_id": {
      "type": "string",
      "default": "${env(\"ARM_TENANT_ID\")}"
    },
    "resource_group_name": {
      "type": "string",
      "default": "${env(\"RESOURCE_GROUP_NAME\")}"
    },
    "gallery_image_name": {
      "type": "string",
      "default": "${env(\"GALLERY_IMAGE_NAME\")}"
    },
    "winrm_password": {
      "type": "string",
      "default": "${env(\"WINRM_PASSWORD\")}"
    },
    "storageAccountKey": {
      "type": "string",
      "default": "${env(\"STORAGE_ACCOUNT_KEY\")}"
    },
    "location": {
      "type": "string",
      "default": "West Europe"
    },
    "gallery_name": {
      "type": "string",
      "default": "acgAk"
    },
    "gallery_image_version": {
      "type": "string",
      "default": "1.0.1"
    },
    "gallery_image_version_updated": {
      "type": "string",
      "default": "1.0.3"
    },
    "storage_account_name": {
      "type": "string",
      "default": "fslogixstorage14"
    },
    "container_name": {
      "type": "string",
      "default": "testinstall"
    },
    "blob_name": {
      "type": "string",
      "default": "setup.exe"
    },
    "script_to_run": {
      "type": "string",
      "default": "Hero.msi"
    },
    "replication_regions": {
      "type": "list(string)",
      "default": ["west europe"]
    },
    "managed_image_nameACG": {
      "type": "string",
      "default": "acgImageDef2"
    }
  },
  "source": {
    "azure-arm": {
      "example": {
        "communicator": "winrm",
        "client_id": "{{user `client_id`}}",
        "client_secret": "{{user `client_secret`}}",
        "subscription_id": "{{user `subscription_id`}}",
        "tenant_id": "{{user `tenant_id`}}",
        "managed_image_name": "myManagedImage16",
        "managed_image_resource_group_name": "{{user `resource_group_name`}}",
        "location": "{{user `location`}}",
        "vm_size": "Standard_DS2_v2",
        "os_type": "Windows",
        "winrm_username": "kun",
        "winrm_password": "{{user `winrm_password`}}",
        "winrm_use_ssl": true,
        "winrm_insecure": true,
        "winrm_timeout": "90m",
        "shared_image_gallery": {
          "subscription": "{{user `subscription_id`}}",
          "resource_group": "{{user `resource_group_name`}}",
          "gallery_name": "{{user `gallery_name`}}",
          "image_name": "{{user `gallery_image_name`}}",
          "image_version": "{{user `gallery_image_version`}}"
        },
        "shared_image_gallery_destination": {
          "gallery_name": "{{user `gallery_name`}}",
          "image_name": "{{user `gallery_image_name`}}",
          "image_version": "{{user `gallery_image_version_updated`}}",
          "replication_regions": "{{user `replication_regions`}}",
          "resource_group": "{{user `resource_group_name`}}"
        }
      }
    }
  },
  "build": {
    "sources": ["source.azure-arm.example"],
    "provisioner": [
      {
        "type": "powershell",
        "inline": [
          "Set-ExecutionPolicy Unrestricted -Scope Process -Force",
          "Set-ExecutionPolicy Unrestricted -Scope CurrentUser -Force",
          "Set-ExecutionPolicy -ExecutionPolicy unrestricted -Scope LocalMachine -Force",
          "Install-PackageProvider -Name NuGet -MinimumVersion 2.8.5.201 -Force -Confirm:$false",
          "Install-Module -Name Az -Repository PSGallery -Force -AllowClobber -Confirm:$false",
          "$context = New-AzStorageContext -StorageAccountName {{user `storage_account_name`}} -StorageAccountKey {{user `storageAccountKey`}}",
          "Get-AzStorageBlobContent -Container {{user `container_name`}} -Blob {{user `blob_name`}} -Destination C:\\Windows\\Temp -Context $context",
          "Get-AzStorageBlobContent -Container {{user `container_name`}} -Blob {{user `script_to_run`}} -Destination C:\\Windows\\Temp -Context $context"
        ]
      },
      {
        "type": "powershell",
        "inline": [
          "$installerPath = 'C:\\Windows\\temp\\setup.exe'",
          "Start-Process -FilePath $installerPath -ArgumentList '/quiet' -Wait -NoNewWindow"
        ]
      },
      {
        "type": "powershell",
        "inline": [
          "Add-WindowsFeature Web-Server",
          "while ((Get-Service RdAgent).Status -ne 'Running') { Start-Sleep -s 5 }",
          "while ((Get-Service WindowsAzureGuestAgent).Status -ne 'Running') { Start-Sleep -s 5 }",
          "& $env:SystemRoot\\System32\\Sysprep\\Sysprep.exe /oobe /generalize /quiet /quit",
          "while($true) { $imageState = Get-ItemProperty HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Setup\\State | Select ImageState; if($imageState.ImageState -ne 'IMAGE_STATE_GENERALIZE_RESEAL_TO_OOBE') { Write-Output $imageState.ImageState; Start-Sleep -s 10  } else { break } }"
        ]
      }
    ],
    "post-processors": {
      "type": "manifest",
      "output": "manifest.json"
    }
  }
}
